#!/usr/bin/env groovy
import groovy.transform.Field

// ============================================================================
// GLOBAL CONSTANTS (CPS SAFE)
// ============================================================================

@Field String REPO_URL = 'https://github.com/ArunaluB/Linearsix-Finacle-Git-Demo.git'
@Field String FINACLE_SERVER = 'findem.linear6.com'
@Field String FINACLE_USER = 'finadm'
@Field String SSH_PORT = '22'
@Field String FINACLE_INSTALL = 'FINDEM'

@Field Map PATHS = [
    base: '/finapp/FIN/DEM/BE/Finacle/FC/app/cust/01/INFENG',
    com: '/finapp/FIN/DEM/BE/Finacle/FC/app/cust/01/INFENG/com',
    mrt: '/finapp/FIN/DEM/BE/Finacle/FC/app/cust/01/INFENG/mrt',
    scripts: '/finapp/FIN/DEM/BE/Finacle/FC/app/cust/01/INFENG/scripts',
    sql: '/finapp/FIN/DEM/BE/Finacle/FC/app/cust/01/INFENG/sql',
    patchArea: '/finutils/customizations_10225/Localizations/patchArea',
    backup: '/finapp/backup'
]

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

def getBranchEnvironment(branch) {
    def b = branch?.replaceAll('origin/', '') ?: 'dev'
    switch(b.toLowerCase()) {
        case 'main':
        case 'master':
        case 'production':
            return 'PRODUCTION'
        case 'uat':
            return 'UAT'
        case 'qa':
            return 'QA'
        default:
            return 'DEV'
    }
}

def executeSSH(key, cmd) {
    sh """
        ssh -i '${key}' \
        -o StrictHostKeyChecking=no \
        -o UserKnownHostsFile=/dev/null \
        -p ${SSH_PORT} \
        ${FINACLE_USER}@${FINACLE_SERVER} \
        "${cmd}"
    """
}

def scpCopy(key, local, remote) {
    sh """
        scp -i '${key}' \
        -o StrictHostKeyChecking=no \
        -o UserKnownHostsFile=/dev/null \
        -r ${local} \
        ${FINACLE_USER}@${FINACLE_SERVER}:${remote}
    """
}

// ============================================================================
// PIPELINE
// ============================================================================

pipeline {
    agent any

    parameters {
        string(name: 'TICKET_NUMBER', defaultValue: '10225')
    }

    options {
        timestamps()
        timeout(time: 2, unit: 'HOURS')
        disableConcurrentBuilds()
    }

    stages {

        stage('ðŸš€ Initialize') {
            steps {
                script {

                    env.DEPLOYMENT_ENV = getBranchEnvironment(env.GIT_BRANCH)
                    env.TIMESTAMP = new Date().format('yyyyMMdd_HHmmss')
                    env.BUILD_ID_CUSTOM = "${env.BUILD_NUMBER}_${env.TIMESTAMP}"

                    echo """
====================================================
FINACLE ENTERPRISE DEPLOYMENT
====================================================
Branch      : ${env.GIT_BRANCH}
Environment : ${env.DEPLOYMENT_ENV}
Ticket      : ${params.TICKET_NUMBER}
Build       : ${env.BUILD_NUMBER}
Commit      : ${env.GIT_COMMIT}
====================================================
"""
                }
            }
        }

        stage('ðŸ” Approval (Prod Only)') {
            when {
                expression { env.DEPLOYMENT_ENV == 'PRODUCTION' }
            }
            steps {
                input message: "Deploy to PRODUCTION?"
            }
        }

        stage('ðŸ’¾ Backup Current Version (ALL BRANCHES)') {
            steps {
                script {

                    withCredentials([sshUserPrivateKey(
                        credentialsId: 'finacle-ssh-key',
                        keyFileVariable: 'SSH_KEY'
                    )]) {

                        def backupDir = "${PATHS.backup}/${env.DEPLOYMENT_ENV.toLowerCase()}/backup_${env.TIMESTAMP}_${params.TICKET_NUMBER}"

                        executeSSH(SSH_KEY, "mkdir -p ${backupDir}")
                        executeSSH(SSH_KEY, "cp -r ${PATHS.base}/* ${backupDir}/ 2>/dev/null || true")

                        echo "Backup created at: ${backupDir}"
                        env.BACKUP_PATH = backupDir
                    }
                }
            }
        }

        stage('ðŸš€ Deploy Files') {
            steps {
                script {

                    withCredentials([sshUserPrivateKey(
                        credentialsId: 'finacle-ssh-key',
                        keyFileVariable: 'SSH_KEY'
                    )]) {

                        if (fileExists('appserver/scripts')) {
                            scpCopy(SSH_KEY, 'appserver/scripts/*', PATHS.scripts)
                            executeSSH(SSH_KEY, "chmod +x ${PATHS.scripts}/*.sh || true")
                        }

                        if (fileExists('appserver/com')) {
                            scpCopy(SSH_KEY, 'appserver/com/*', PATHS.com)
                        }

                        if (fileExists('appserver/mrt')) {
                            scpCopy(SSH_KEY, 'appserver/mrt/*', PATHS.mrt)
                        }

                        if (fileExists('appserver/sql')) {
                            scpCopy(SSH_KEY, 'appserver/sql/*', PATHS.sql)
                        }

                        executeSSH(SSH_KEY,
                            "echo 'Deployment ${env.TIMESTAMP}' > ${PATHS.patchArea}/DEPLOY_${env.TIMESTAMP}.txt"
                        )

                        echo "Deployment completed."
                    }
                }
            }
        }

        stage('ðŸ“Š Audit Report') {
            steps {
                script {

                    def report = """
====================================================
FINACLE DEPLOYMENT AUDIT
====================================================
Environment  : ${env.DEPLOYMENT_ENV}
Ticket       : ${params.TICKET_NUMBER}
Build        : ${env.BUILD_NUMBER}
Commit       : ${env.GIT_COMMIT}
Backup Path  : ${env.BACKUP_PATH}
Timestamp    : ${env.TIMESTAMP}
Status       : SUCCESS
====================================================
"""

                    writeFile file: "AUDIT_${env.TIMESTAMP}.txt", text: report
                    archiveArtifacts artifacts: "AUDIT_${env.TIMESTAMP}.txt"
                    echo report
                }
            }
        }
    }

    post {
        success {
            emailext(
                subject: "[${env.DEPLOYMENT_ENV}] Deployment SUCCESS - Ticket ${params.TICKET_NUMBER}",
                body: "Deployment successful.\nBuild: ${env.BUILD_URL}",
                to: EMAIL_RECIPIENTS
            )
        }

        failure {
            script {
                if (env.BACKUP_PATH) {
                    withCredentials([sshUserPrivateKey(
                        credentialsId: 'finacle-ssh-key',
                        keyFileVariable: 'SSH_KEY'
                    )]) {

                        executeSSH(SSH_KEY,
                            "cp -r ${env.BACKUP_PATH}/* ${PATHS.base}/ 2>/dev/null || true"
                        )

                        echo "Rollback executed from ${env.BACKUP_PATH}"
                    }
                }
            }

            emailext(
                subject: "[${env.DEPLOYMENT_ENV}] Deployment FAILED - Ticket ${params.TICKET_NUMBER}",
                body: "Deployment failed.\nCheck console: ${env.BUILD_URL}console",
                to: EMAIL_RECIPIENTS,
                attachLog: true
            )
        }
    }
}
