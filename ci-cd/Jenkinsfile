#!/usr/bin/env groovy
/*
 * Enterprise Finacle CI/CD Pipeline - PRODUCTION READY
 * Version: 2.0.2 (Windows Fixed)
 * Supports: DEV, QA, UAT, PRODUCTION
 * Organization: Finacle Deployment System
 * Author: DevOps Team
 * Last Updated: 2026-02-16
 * 
 * CHANGES:
 * - Fixed: Windows path handling for Git Bash
 * - Fixed: SSH key path conversion for Windows
 * - Fixed: Script execution paths
 */

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

// Get Git Bash path for Windows
def getGitBashPath() {
    def gitBashPaths = [
        'C:\\Program Files\\Git\\bin\\bash.exe',
        'C:\\Program Files (x86)\\Git\\bin\\bash.exe',
        'C:\\Git\\bin\\bash.exe',
        '/usr/bin/bash'
    ]
    
    for (path in gitBashPaths) {
        if (fileExists(path)) {
            echo "‚úÖ Found Git Bash at: ${path}"
            return path
        }
    }
    return 'bash' // fallback
}

// Convert Windows path to Git Bash compatible path - FIXED VERSION
def toGitBashPath(windowsPath) {
    if (!windowsPath) return windowsPath
    if (isUnix()) return windowsPath
    
    echo "DEBUG: Converting path: ${windowsPath}"
    
    // For Windows, handle path conversion properly
    def fixedPath = windowsPath
    
    // Convert backslashes to forward slashes
    fixedPath = fixedPath.replaceAll('\\\\', '/')
    
    // Handle drive letters (C: -> /c)
    fixedPath = fixedPath.replaceAll('^([A-Za-z]):', { match -> "/${match[1].toLowerCase()}" })
    
    // Remove any leading /c/Program Files/Git if it's already there
    fixedPath = fixedPath.replaceFirst('^/c/Program Files/Git', '')
    
    echo "DEBUG: Converted to: ${fixedPath}"
    return fixedPath
}

// Determine environment from branch
def getBranchEnvironment(branch) {
    if (!branch) return 'DEV'
    
    def branchName = branch.toString().trim()
    
    // Remove 'origin/' prefix if present
    branchName = branchName.replaceAll('^origin/', '')
    // Remove 'refs/remotes/origin/' prefix if present
    branchName = branchName.replaceAll('^refs/remotes/origin/', '')
    
    echo "DEBUG: Processing branch: ${branchName}"
    
    switch(branchName.toLowerCase()) {
        case 'main':
        case 'master':
        case 'production':
        case 'prod':
            return 'PRODUCTION'
        case 'uat':
            return 'UAT'
        case 'qa':
            return 'QA'
        case 'dev':
        case 'develop':
        case ~/^DEV-.*/:
            return 'DEV'
        default:
            echo "WARNING: Unknown branch pattern '${branchName}', defaulting to DEV"
            return 'DEV'
    }
}

// Test SSH connectivity with retries
def testSSHConnection(sshKeyPath, maxRetries = 3) {
    echo "üîç Testing SSH connection to ${env.FINACLE_SERVER}..."
    
    def connected = false
    def retryCount = 0
    
    while (!connected && retryCount < maxRetries) {
        try {
            def testCmd = "ssh -i '${sshKeyPath}' " +
                         "-o ConnectTimeout=15 " +
                         "-o StrictHostKeyChecking=no " +
                         "-o BatchMode=yes " +
                         "-o UserKnownHostsFile=/dev/null " +
                         "-p ${env.SSH_PORT} " +
                         "${env.FINACLE_USER}@${env.FINACLE_SERVER} " +
                         "'echo SSH_OK && hostname && whoami'"
            
            if (isUnix()) {
                def result = sh(script: testCmd, returnStatus: true)
                connected = (result == 0)
            } else {
                def gitBash = getGitBashPath()
                def sshKeyUnix = toGitBashPath(sshKeyPath)
                def cmd = "ssh -i '${sshKeyUnix}' -o ConnectTimeout=15 -o StrictHostKeyChecking=no -o BatchMode=yes -o UserKnownHostsFile=/dev/null -p ${env.SSH_PORT} ${env.FINACLE_USER}@${env.FINACLE_SERVER} 'echo SSH_OK && hostname && whoami'"
                
                def result = bat(script: """
                    @echo off
                    "${gitBash}" -c "${cmd}"
                """, returnStatus: true)
                connected = (result == 0)
            }
            
            if (connected) {
                echo "‚úÖ SSH connection successful!"
                return true
            }
        } catch (Exception e) {
            echo "‚ö†Ô∏è  SSH connection attempt ${retryCount + 1} failed: ${e.message}"
        }
        
        retryCount++
        if (!connected && retryCount < maxRetries) {
            echo "üîÑ Retrying SSH connection in 5 seconds... (${retryCount}/${maxRetries})"
            sleep(5)
        }
    }
    
    return connected
}

// ============================================================================
// PIPELINE DEFINITION
// ============================================================================
pipeline {
    agent any
    
    parameters {
        choice(
            name: 'DEPLOYMENT_MODE',
            choices: ['JENKINS_AUTO', 'LOCAL_PC_MANUAL'],
            description: 'Deployment mode selection'
        )
        string(
            name: 'TICKET_NUMBER',
            defaultValue: '10225',
            description: 'Patch/Ticket Number (e.g., 10225)'
        )
        string(
            name: 'FIN_INSTALL_ID',
            defaultValue: 'FINDEM',
            description: 'Finacle Installation ID'
        )
        booleanParam(
            name: 'SKIP_SSH_TEST',
            defaultValue: false,
            description: 'Skip SSH connectivity test'
        )
        booleanParam(
            name: 'ENABLE_BACKUP',
            defaultValue: true,
            description: 'Create backup before deployment'
        )
        booleanParam(
            name: 'SKIP_VALIDATION',
            defaultValue: false,
            description: 'Skip pre-deployment validation'
        )
        booleanParam(
            name: 'SKIP_FINL',
            defaultValue: false,
            description: 'Skip FINL validation'
        )
        booleanParam(
            name: 'SKIP_SERVICE_RESTART',
            defaultValue: false,
            description: 'Skip service restart after deployment'
        )
    }
    
    environment {
        // ====================================================================
        // GLOBAL CONFIGURATION
        // ====================================================================
        REPO_URL = 'https://github.com/ArunaluB/Linearsix-Finacle-Git-Demo.git'
        FINACLE_SERVER = 'findem.linear6.com'
        FINACLE_USER = 'finadm'
        SSH_PORT = '22'
        FINACLE_INSTALL = "${params.FIN_INSTALL_ID}"
        
        // Finacle Server Paths
        BASE_PATH = '/finapp/FIN/DEM/BE/Finacle/FC/app/cust/01/INFENG'
        PATH_COM = '/finapp/FIN/DEM/BE/Finacle/FC/app/cust/01/INFENG/com'
        PATH_MRT = '/finapp/FIN/DEM/BE/Finacle/FC/app/cust/01/INFENG/mrt'
        PATH_SCRIPTS = '/finapp/FIN/DEM/BE/Finacle/FC/app/cust/01/INFENG/scripts'
        PATH_SQL = '/finapp/FIN/DEM/BE/Finacle/FC/app/cust/01/INFENG/sql'
        PATH_CUSTOMIZATIONS = '/finutils/customizations'
        PATH_PATCH_BASE = "/finutils/customizations_${params.TICKET_NUMBER}/Localizations"
        PATH_PATCH_AREA = "/finutils/customizations_${params.TICKET_NUMBER}/Localizations/patchArea"
        PATH_FINAL_DELIVERY = "/finutils/customizations_${params.TICKET_NUMBER}/Localizations/FinalDelivery"
        PATH_BACKUP = "/finapp/backup"
        PATH_LOGS = '/var/log/finacle-deployments'
        PATH_FINLISTVAL = '/finservices/FIN/DEM/finlistval/bin'
        PATH_CORESESSION = '/finservices/FIN/DEM/coresession/bin'
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '30', daysToKeepStr: '60'))
        timestamps()
        ansiColor('xterm')
        timeout(time: 2, unit: 'HOURS')
        disableConcurrentBuilds()
    }
    
    stages {
        stage('üöÄ Initialize & Test Connection') {
            steps {
                script {
                    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
                    echo "‚ïë          FINACLE CI/CD PIPELINE - INITIALIZATION              ‚ïë"
                    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
                    echo ""
                    
                    // Generate timestamp
                    if (isUnix()) {
                        env.TIMESTAMP = sh(script: "date '+%Y%m%d_%H%M%S'", returnStdout: true).trim()
                    } else {
                        env.TIMESTAMP = bat(
                            script: '@echo off & powershell -Command "Get-Date -Format \"yyyyMMdd_HHmmss\""',
                            returnStdout: true
                        ).trim()
                    }
                    env.BUILD_ID_CUSTOM = "${BUILD_NUMBER}_${env.TIMESTAMP}"
                    
                    // Determine environment from branch
                    env.BRANCH_NAME = env.GIT_BRANCH ?: 'dev'
                    env.DEPLOYMENT_ENV = getBranchEnvironment(env.BRANCH_NAME)
                    
                    echo "üìã Build Information:"
                    echo "   Branch: ${env.BRANCH_NAME}"
                    echo "   Environment: ${env.DEPLOYMENT_ENV}"
                    echo "   Ticket: ${params.TICKET_NUMBER}"
                    echo "   Build: ${BUILD_NUMBER}"
                    echo "   Build ID: ${env.BUILD_ID_CUSTOM}"
                    echo ""
                    
                    // Test SSH connection
                    if (!params.SKIP_SSH_TEST) {
                        withCredentials([sshUserPrivateKey(
                            credentialsId: 'finacle-ssh-key',
                            keyFileVariable: 'SSH_KEY_FILE',
                            usernameVariable: 'SSH_USER'
                        )]) {
                            def sshKeyPath = isUnix() ? SSH_KEY_FILE : toGitBashPath(SSH_KEY_FILE)
                            
                            if (!testSSHConnection(sshKeyPath)) {
                                error("‚ùå SSH connection test failed")
                            }
                        }
                    }
                }
            }
        }
        
        stage('üíæ Backup Current Version') {
            when {
                expression { params.ENABLE_BACKUP }
            }
            steps {
                script {
                    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
                    echo "‚ïë              CREATING BACKUP - ${env.DEPLOYMENT_ENV}         ‚ïë"
                    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
                    
                    withCredentials([sshUserPrivateKey(
                        credentialsId: 'finacle-ssh-key',
                        keyFileVariable: 'SSH_KEY_FILE',
                        usernameVariable: 'SSH_USER'
                    )]) {
                        def sshKeyPath = isUnix() ? SSH_KEY_FILE : toGitBashPath(SSH_KEY_FILE)
                        def bashCmd = getGitBashPath()
                        def scriptPath = "${WORKSPACE}/scripts/backup_files.sh"
                        def scriptPathGitBash = toGitBashPath(scriptPath)
                        
                        echo "üì¶ Creating backup..."
                        env.BACKUP_PATH = "${env.PATH_BACKUP}/${env.DEPLOYMENT_ENV}_${params.TICKET_NUMBER}_${env.TIMESTAMP}"
                        
                        if (isUnix()) {
                            sh """
                                export SSH_KEY_FILE='${SSH_KEY_FILE}'
                                export FINACLE_USER='${env.FINACLE_USER}'
                                bash ${scriptPath} \
                                    --environment '${env.DEPLOYMENT_ENV}' \
                                    --ticket '${params.TICKET_NUMBER}' \
                                    --timestamp '${env.TIMESTAMP}'
                            """
                        } else {
                            bat """
                                @echo off
                                set SSH_KEY_FILE=${SSH_KEY_FILE}
                                set FINACLE_USER=${env.FINACLE_USER}
                                "${bashCmd}" -c "${scriptPathGitBash} --environment '${env.DEPLOYMENT_ENV}' --ticket '${params.TICKET_NUMBER}' --timestamp '${env.TIMESTAMP}'"
                            """
                        }
                        
                        echo "‚úÖ Backup created: ${env.BACKUP_PATH}"
                    }
                }
            }
        }
        
        stage('üöÄ Deploy Files') {
            steps {
                script {
                    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
                    echo "‚ïë              DEPLOYING TO ${env.DEPLOYMENT_ENV}               ‚ïë"
                    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
                    
                    withCredentials([sshUserPrivateKey(
                        credentialsId: 'finacle-ssh-key',
                        keyFileVariable: 'SSH_KEY_FILE',
                        usernameVariable: 'SSH_USER'
                    )]) {
                        def sshKeyPath = isUnix() ? SSH_KEY_FILE : toGitBashPath(SSH_KEY_FILE)
                        def bashCmd = getGitBashPath()
                        
                        // Get changed files
                        def changedFiles = []
                        if (isUnix()) {
                            changedFiles = sh(
                                script: "git diff --name-only HEAD~1 HEAD || git ls-files",
                                returnStdout: true
                            ).trim().split('\n')
                        } else {
                            changedFiles = bat(
                                script: "@echo off & \"${bashCmd}\" -c \"git diff --name-only HEAD~1 HEAD || git ls-files\"",
                                returnStdout: true
                            ).trim().split('\n')
                        }
                        
                        // Deploy each file
                        changedFiles.each { file ->
                            if (!file || !file.trim()) return
                            
                            def fileExt = file.split('\\.').last()
                            def fullPath = "${WORKSPACE}/${file}"
                            
                            if (!fileExists(fullPath)) {
                                echo "‚ö†Ô∏è  File not found: ${fullPath}, skipping..."
                                return
                            }
                            
                            switch(fileExt) {
                                case 'scr':
                                    def scrScriptPath = "${WORKSPACE}/scripts/deploy_scr.sh"
                                    def scrScriptGitBash = toGitBashPath(scrScriptPath)
                                    def fullPathGitBash = toGitBashPath(fullPath)
                                    
                                    if (isUnix()) {
                                        sh """
                                            export SSH_KEY_FILE='${SSH_KEY_FILE}'
                                            export FINACLE_USER='${env.FINACLE_USER}'
                                            export GIT_BRANCH='${env.BRANCH_NAME}'
                                            bash ${scrScriptPath} \
                                                --file '${fullPath}' \
                                                --environment '${env.DEPLOYMENT_ENV}' \
                                                --ticket '${params.TICKET_NUMBER}'
                                        """
                                    } else {
                                        bat """
                                            @echo off
                                            set SSH_KEY_FILE=${SSH_KEY_FILE}
                                            set FINACLE_USER=${env.FINACLE_USER}
                                            set GIT_BRANCH=${env.BRANCH_NAME}
                                            "${bashCmd}" -c "${scrScriptGitBash} --file '${fullPathGitBash}' --environment '${env.DEPLOYMENT_ENV}' --ticket '${params.TICKET_NUMBER}'"
                                        """
                                    }
                                    break
                                    
                                case 'sql':
                                    def sqlScriptPath = "${WORKSPACE}/scripts/deploy_sql.sh"
                                    def sqlScriptGitBash = toGitBashPath(sqlScriptPath)
                                    def fullPathGitBash = toGitBashPath(fullPath)
                                    
                                    if (isUnix()) {
                                        sh """
                                            export SSH_KEY_FILE='${SSH_KEY_FILE}'
                                            export FINACLE_USER='${env.FINACLE_USER}'
                                            bash ${sqlScriptPath} \
                                                --file '${fullPath}' \
                                                --environment '${env.DEPLOYMENT_ENV}' \
                                                --ticket '${params.TICKET_NUMBER}'
                                        """
                                    } else {
                                        bat """
                                            @echo off
                                            set SSH_KEY_FILE=${SSH_KEY_FILE}
                                            set FINACLE_USER=${env.FINACLE_USER}
                                            "${bashCmd}" -c "${sqlScriptGitBash} --file '${fullPathGitBash}' --environment '${env.DEPLOYMENT_ENV}' --ticket '${params.TICKET_NUMBER}'"
                                        """
                                    }
                                    break
                                    
                                case ['com', 'mrt']:
                                    def comScriptPath = "${WORKSPACE}/scripts/deploy_com_mrt.sh"
                                    def comScriptGitBash = toGitBashPath(comScriptPath)
                                    def fullPathGitBash = toGitBashPath(fullPath)
                                    
                                    if (isUnix()) {
                                        sh """
                                            export SSH_KEY_FILE='${SSH_KEY_FILE}'
                                            export FINACLE_USER='${env.FINACLE_USER}'
                                            bash ${comScriptPath} \
                                                --file '${fullPath}' \
                                                --environment '${env.DEPLOYMENT_ENV}' \
                                                --ticket '${params.TICKET_NUMBER}'
                                        """
                                    } else {
                                        bat """
                                            @echo off
                                            set SSH_KEY_FILE=${SSH_KEY_FILE}
                                            set FINACLE_USER=${env.FINACLE_USER}
                                            "${bashCmd}" -c "${comScriptGitBash} --file '${fullPathGitBash}' --environment '${env.DEPLOYMENT_ENV}' --ticket '${params.TICKET_NUMBER}'"
                                        """
                                    }
                                    break
                            }
                        }
                        
                        echo "‚úÖ All files deployed"
                    }
                }
            }
        }
        
        stage('üîç Post-Deployment Verification') {
            steps {
                script {
                    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
                    echo "‚ïë          POST-DEPLOYMENT VERIFICATION                         ‚ïë"
                    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
                    
                    withCredentials([sshUserPrivateKey(
                        credentialsId: 'finacle-ssh-key',
                        keyFileVariable: 'SSH_KEY_FILE',
                        usernameVariable: 'SSH_USER'
                    )]) {
                        def sshKeyPath = isUnix() ? SSH_KEY_FILE : toGitBashPath(SSH_KEY_FILE)
                        def bashCmd = getGitBashPath()
                        
                        // Run FINL validation
                        if (!params.SKIP_FINL) {
                            def finlScript = "${WORKSPACE}/scripts/run_finl.sh"
                            def finlScriptGitBash = toGitBashPath(finlScript)
                            
                            if (isUnix()) {
                                sh """
                                    export SSH_KEY_FILE='${SSH_KEY_FILE}'
                                    export FINACLE_USER='${env.FINACLE_USER}'
                                    bash ${finlScript} '${env.FINACLE_INSTALL}'
                                """
                            } else {
                                bat """
                                    @echo off
                                    set SSH_KEY_FILE=${SSH_KEY_FILE}
                                    set FINACLE_USER=${env.FINACLE_USER}
                                    "${bashCmd}" -c "${finlScriptGitBash} '${env.FINACLE_INSTALL}'"
                                """
                            }
                        }
                        
                        // Restart services
                        if (!params.SKIP_SERVICE_RESTART) {
                            def restartScript = "${WORKSPACE}/scripts/restart_services.sh"
                            def restartScriptGitBash = toGitBashPath(restartScript)
                            
                            if (isUnix()) {
                                sh """
                                    export SSH_KEY_FILE='${SSH_KEY_FILE}'
                                    export FINACLE_USER='${env.FINACLE_USER}'
                                    bash ${restartScript} '${env.FINACLE_INSTALL}'
                                """
                            } else {
                                bat """
                                    @echo off
                                    set SSH_KEY_FILE=${SSH_KEY_FILE}
                                    set FINACLE_USER=${env.FINACLE_USER}
                                    "${bashCmd}" -c "${restartScriptGitBash} '${env.FINACLE_INSTALL}'"
                                """
                            }
                        }
                    }
                }
            }
        }
    }
    
    post {
        success {
            script {
                echo "‚úÖ Deployment Successful"
            }
        }
        
        failure {
            script {
                echo "‚ùå Deployment Failed"
                
                // Attempt rollback if backup exists
                if (env.BACKUP_PATH) {
                    echo "üîÑ Attempting rollback..."
                    
                    withCredentials([sshUserPrivateKey(
                        credentialsId: 'finacle-ssh-key',
                        keyFileVariable: 'SSH_KEY_FILE',
                        usernameVariable: 'SSH_USER'
                    )]) {
                        def sshKeyPath = isUnix() ? SSH_KEY_FILE : toGitBashPath(SSH_KEY_FILE)
                        def bashCmd = getGitBashPath()
                        def rollbackScript = "${WORKSPACE}/scripts/rollback_deployment.sh"
                        def rollbackScriptGitBash = toGitBashPath(rollbackScript)
                        
                        if (isUnix()) {
                            sh """
                                export SSH_KEY_FILE='${SSH_KEY_FILE}'
                                export FINACLE_USER='${env.FINACLE_USER}'
                                bash ${rollbackScript} \
                                    --environment '${env.DEPLOYMENT_ENV}' \
                                    --ticket '${params.TICKET_NUMBER}' \
                                    --timestamp '${env.TIMESTAMP}'
                            """
                        } else {
                            bat """
                                @echo off
                                set SSH_KEY_FILE=${SSH_KEY_FILE}
                                set FINACLE_USER=${env.FINACLE_USER}
                                "${bashCmd}" -c "${rollbackScriptGitBash} --environment '${env.DEPLOYMENT_ENV}' --ticket '${params.TICKET_NUMBER}' --timestamp '${env.TIMESTAMP}'"
                            """
                        }
                    }
                }
            }
        }
        
        always {
            script {
                // Archive artifacts
                archiveArtifacts(
                    artifacts: '**/*.log,**/*.txt,DEPLOYMENT_AUDIT_*.txt',
                    allowEmptyArchive: true
                )
            }
        }
    }
}